# ============================================================================
# GENERAL OPTIONS
# ============================================================================

# Mouse support and terminal settings
set -g mouse on
set -g default-terminal "tmux-256color"
set-option -sa terminal-overrides ",xterm*:Tc"
set-option -g status-position top
set -g set-clipboard on
set -g detach-on-destroy off # Don't exit from tmux when closing a session


# Window and pane numbering
set -g base-index 1                   # Start windows at 1, not 0
setw -g pane-base-index 1             # Start panes at 1, not 0
set-window-option -g pane-base-index 1
set-option -g renumber-windows on     # Renumber windows when one is closed

# Window behavior
set-option -g allow-rename off        # Don't rename windows automatically

# Enable Yazi Image Previewer
set -g allow-passthrough on
set -ga update-environment TERM
set -ga update-environment TERM_PROGRAM

# ============================================================================
# Window popups
# ============================================================================
# Popup session switcher / creator with fzf
# - shows list of sessions
# - Ctrl-K kills a session (and reloads list)
# - Enter on existing session → switch
# - Enter on query → create + switch
# - Preview pane shows windows inside the session
bind o display-popup -w 80% -h 70% -E "$HOME/.config/tmux/scripts/session-fzf.sh"

# Key bindings help
bind k display-popup \
    -w 90% \
    -h 100% \
    -E "tmux list-keys | fzf"

# AI Assistant popup
bind a display-popup -w 40% -h 80% -E "fish -c 'ask -i'"

# ============================================================================
# PREFIX KEY
# ============================================================================

unbind C-b
set -g prefix `
bind ` send-prefix

# ============================================================================
# KEY BINDINGS
# ============================================================================

# Configuration reload
unbind r
bind r source-file ~/.config/tmux/tmux.conf \; display-message "tmux.conf reloaded ☺️"

# Pane splitting (open in current directory)
bind '"' split-window -v -c "#{pane_current_path}"
bind '-' split-window -v -c "#{pane_current_path}"
bind % split-window -h -c "#{pane_current_path}"
bind '|' split-window -h -c "#{pane_current_path}"

# New window in same path
bind c new-window -c "#{pane_current_path}"
bind-key S command-prompt -p "Session name:" "new-session -s '%%'"

# Window navigation
bind -n C-H previous-window
bind -n C-L next-window
bind -n M-S-Left previous-window
bind -n M-S-Right next-window

# Smart pane/window navigation with Alt + Arrow keys
# Alt + Left/Right switches panes unless at screen edge, then switches windows
bind -n M-Left if-shell "tmux display-message -p '#{pane_at_left}' | grep -q 1" "previous-window" "select-pane -L"
bind -n M-Right if-shell "tmux display-message -p '#{pane_at_right}' | grep -q 1" "next-window" "select-pane -R"
bind -n M-Up select-pane -U
bind -n M-Down select-pane -D

# Pane resizing with leader + HJKL
bind -r H resize-pane -L 5
bind -r J resize-pane -D 5
bind -r K resize-pane -U 5
bind -r L resize-pane -R 5
bind -r m resize-pane -Z # Use m key to maximize pane

# Pane resizing with leader + Arrow keys
bind -r Left resize-pane -L 5
bind -r Down resize-pane -D 5
bind -r Up resize-pane -U 5
bind -r Right resize-pane -R 5

# Window reordering
bind-key -n M-i swap-window -t -1\; select-window -t -1
bind-key -n M-o swap-window -t +1\; select-window -t +1

# ============================================================================
# VI MODE & COPY MODE
# ============================================================================

# Highlight pane when entering copy mode
set-hook -g pane-mode-changed { if -F "#{pane_in_mode}" "selectp -P bg=#181818" "selectp -P default" }

set-window-option -g mode-keys vi

# Vi-style copy mode keybindings
bind-key -T copy-mode-vi v send-keys -X begin-selection
bind-key -T copy-mode-vi C-v send-keys -X rectangle-toggle
bind-key -T copy-mode-vi y send-keys -X copy-selection-and-cancel "pbcopy"

# AI Ask with selection - copy selection and open AI chat
bind-key -T copy-mode-vi a send-keys -X copy-selection \; run-shell "$HOME/.config/tmux/scripts/ai-ask-selection.sh"

# Don't exit copy mode when dragging with mouse
unbind -T copy-mode-vi MouseDragEnd1Pane

# ============================================================================
# PLUGINS
# ============================================================================

# Plugin manager
set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'tmux-plugins/tmux-sensible'

# Theme
set -g @plugin 'catppuccin/tmux'

# Functionality plugins
set -g @plugin 'christoomey/vim-tmux-navigator'
set -g @plugin 'tmux-plugins/tmux-yank'
set -g @plugin 'omerxx/tmux-floax'
set -g @plugin 'tmux-plugins/tmux-resurrect'
set -g @plugin 'tmux-plugins/tmux-continuum'
set -g @plugin 'tmux-plugins/tmux-open'

# Commented out plugins (uncomment if needed)
# set -g @plugin 'tmux-plugins/tmux-cpu'
# set -g @plugin 'tmux-plugins/tmux-battery'

# ============================================================================
# PLUGIN CONFIGURATION
# ============================================================================

# Enable tmux-resurrect to capture pane contents and tmux-continuum to automatically restore sessions
set -g @resurrect-capture-pane-contents 'on'
set -g @continuum-restore 'on'

# Floax configuration
# M- means "hold Meta/Alt"
set -g @floax-bind '-n M-f'

# Catppuccin theme configuration
set -g @catppuccin_flavor "frappe"
set -g @catppuccin_window_status_style "basic"
set -g @catppuccin_window_current_text " #{window_name}"
set -g @catppuccin_window_text " #{window_name}"
set -g @catppuccin_window_current_number_color "#{?window_zoomed_flag,#{@thm_yellow},#{@thm_mauve}}"
set -g @catppuccin_window_number_color "#{?window_zoomed_flag,#{@thm_yellow},#{@thm_overlay_2}}"

# ============================================================================
# STATUS LINE CONFIGURATION
# ============================================================================

# Status line length settings
set -g status-right-length 100
set -g status-left-length 100
set -g status-left ""

# Status line modules
set -g status-right "#{E:@catppuccin_status_application}"
set -ag status-right "#{E:@catppuccin_status_session}"

# Commented out status modules (uncomment if needed)
# set -agF status-right "#{E:@catppuccin_status_cpu}"
# set -ag status-right "#{E:@catppuccin_status_uptime}"
# set -agF status-right "#{E:@catppuccin_status_battery}"

# ============================================================================
# INITIALIZE PLUGIN MANAGER
# ============================================================================

# Initialize TPM (keep this line at the very bottom of tmux.conf)
run '~/.config/tmux/plugins/tpm/tpm'
